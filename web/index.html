<!DOCTYPE html>
<html>
<head>
<title>OSC Node.js Bitwig</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" sizes="180x180" href="assets/images/bitwig-192.png">

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" type="text/css" media="all" href="assets/css/bitwig.css"></link>
<script src="node_modules/jquery/dist/jquery.js"></script>
<script src="node_modules/osc/dist/osc-browser.min.js"></script>
<script src="../local-url.js"></script>
<!-- <script src="assets/js/live.js"></script> -->

<script type="text/javascript">

var port = new osc.WebSocketPort({
	url: localURL
});

var bitwig = {};

bitwig.parseMessage = function (oscMessage) {

	var currentMessage = oscMessage;
	console.log(">> bitwig.parseMessage: " + currentMessage.address);
	console.log(currentMessage.args);

	if (currentMessage.address == "/track/device/cursor"){
		bitwig.cursorDeviceSet(currentMessage);
	// } else if (currentMessage.address == "/track/color"){
	// 	bitwig.currentTrackColor(currentMessage);
	// } else if (currentMessage.address == "/track/devices"){
	// 	// bitwig.currentTrackDevices(currentMessage);
	}

}

bitwig.cursorDeviceSet = function (oscMessage) {

	console.log(">> bitwig.cursorDeviceSet");
	console.log("cursorDeviceIndex is: " + oscMessage.args[0]);

	var cursorDeviceIndex = oscMessage.args[0];

	var devices = $(".device");

	devices.removeClass( "deviceActive" );
	$(".deviceSlot").removeClass( "slotActive" );
	$.each( devices, function( index, value ){
		if(index == cursorDeviceIndex ){
			$( this ).addClass( "deviceActive" );
		} 
	});

}

bitwig.currentTrackName = function (oscMessage) {

	console.log(">> bitwig.currentTrackName");
	console.log(oscMessage.args[0]);

	var currentTrack = oscMessage;
	var trackName = oscMessage.args[0];
	$("#currentTrack").text(trackName);

}

bitwig.currentTrackColor = function (oscMessage) {

	console.log(">> bitwig.currentTrackColor");
	console.log(oscMessage.args[0]);
	console.log(oscMessage.args[1]);
	console.log(oscMessage.args[2]);

	var currentTrack = oscMessage;
	var trackRed = oscMessage.args[0];
	var trackGreen = oscMessage.args[1];
	var trackBlue = oscMessage.args[2];

	var strBegin = "rgb(";
	var strComma = ", ";
	var strEnd = ")";
	var strFull = strBegin.concat(trackRed, strComma, trackGreen, strComma, trackBlue, strEnd);
	console.log(strFull);

	$("#currentTrack").css("background-color", strFull);

}

bitwig.currentTrackDevices = function (oscMessage) {

	// console.log(">> bitwig.currentTrackDevices");
	// console.log("incoming osc is" + oscMessage.args);

	// var cursorDeviceIndex = oscMessage.args[0];

	// oscMessage.args.splice(0,1);
	// // console.log("after splie" + oscMessage.args);

	// var currentTrack = oscMessage;
	// // var trackDevice1 = oscMessage.args[0];
	// // $("#currentTrack").text(trackName);

	// $('#devices').html('')
	// $.each( currentTrack.args, function( index, value ){
	// 	if(index == cursorDeviceIndex ){
	// 		console.log("inside if...")
	// 		$('#devices').append('<button data-device-index="' + index + '"' + ' class="deviceActive"'  + '>'+ value +'</button>');
	// 	} else {
	// 		console.log("inside else...")
	// 		$('#devices').append('<button data-device-index="' + index + '">'+ value +'</button>');
	// 	}

	// });

	// $("#devices button").on( "click", function() {

	// 	$(".device").removeClass( "deviceActive" );
	// 	$(".deviceSlot").removeClass( "slotActive" );
	// 	$( this ).addClass( "deviceActive" );
	// 	var currentDeviceIndex = $( this ).data( "device-index" );
	// 	// console.log("currentDeviceIndex is " + currentDeviceIndex );
	// 	port.send({
	// 		address: "/device",
	// 		args: [currentDeviceIndex]
	// 	});

	// });

};

port.on("message", function (oscMessage) {
	// $("#message").text(JSON.stringify(oscMessage, undefined, 2));
	bitwig.parseMessage(oscMessage);
});


bitwig.parseBundle = function (oscBundle) {

	console.log("bundle received..." + oscBundle.packets[0].address);

	if(oscBundle.packets[0].address == "/track"){

		$("#message").text(JSON.stringify(oscBundle, null, 2));

		console.log(oscBundle);

		var trackName = oscBundle.packets[0].args[0];
		console.log("track name is: " + trackName);
		$("#currentTrack").text(trackName);

		var trackColor = oscBundle.packets[1];
		console.log("track color is: " + trackColor);
		var trackRed = trackColor.args[0];
		var trackGreen = trackColor.args[1];
		var trackBlue = trackColor.args[2];
		var strBegin = "rgb(";
		var strComma = ", ";
		var strEnd = ")";
		var strFull = strBegin.concat(trackRed, strComma, trackGreen, strComma, trackBlue, strEnd);
		console.log(strFull);
		$("#currentTrack").css("background-color", strFull);

		var devices = oscBundle.packets[2].packets;
		console.log("devices inside this track:");
		console.log(devices);

		var currentDeviceIndex = devices[0].args[0];
		console.log("current device index is:");
		console.log(currentDeviceIndex);

		devices.splice(0,1);

		$('#devices').html('')
		$.each( devices, function( index, value ){

			// console.log("devices array index is:" + index);
			// console.log("devices array value is:");
			var deviceName = value.packets[0].args[0];
			// console.log(deviceName);

			if(index == currentDeviceIndex ){
				$('#devices').append('<button class="device deviceActive" data-device-index="' + index + '"' + '>'+ deviceName +'</button>');
			} else {
				$('#devices').append('<button class="device" data-device-index="' + index + '">'+ deviceName +'</button>');
			}

			var deviceSlots = value.packets[1].packets;

			// 	console.log("slots array index is:" + slotIndex);
			// console.log("slots array value is:");
			// 	var deviceName = value.packets[0].args[0];
			// console.log(deviceSlots);

			$.each( deviceSlots, function( slotIndex, slotValue ){

				// console.log("slots array index is:" + slotIndex);
				// console.log("slots array value is:");
				var deviceSlot = slotValue.args[0];
				// console.log(deviceSlot);

				$('#devices').append('<button class="deviceSlot" data-slot-name="'+deviceSlot+'" data-slot-index="' + slotIndex + '">'+ deviceSlot +'</button>');
			});

		});

		$(".deviceSlot").on( "click", function() {

			$(".device").removeClass( "deviceActive" );
			$(".deviceSlot").removeClass( "slotActive" );
			$( this ).addClass( "slotActive" );

			var deviceSlotName = $( this ).data( "slot-name" );
			console.log("deviceSlotName is " + deviceSlotName );
			port.send({
				address: "/device-slot",
				args: [deviceSlotName]
			});

		});


		$(".device").on( "click", function() {

			$(".device").removeClass( "deviceActive" );
			$(".deviceSlot").removeClass( "slotActive" );
			$( this ).addClass( "deviceActive" );
			var currentDeviceIndex = $( this ).data( "device-index" );
			// console.log("currentDeviceIndex is " + currentDeviceIndex );
			port.send({
				address: "/device",
				args: [currentDeviceIndex]
			});

		});

		// var device1 = devices[1].packets[0].args[0];
		// console.log("device1:");
		// console.log(device1);

		// console.log("device1Slot 1:");
		// var device1Slot1 = devices[1].packets[1].packets[0].args[0];
		// console.log(device1Slot1);

		// console.log("device1Slot 2:");
		// var device1Slot2 = devices[1].packets[1].packets[1].args[0];
		// console.log(device1Slot2);

		// var device2 = devices[2].packets[0].args[0];
		// console.log("device2:");
		// console.log(device2);

	} else if (oscBundle.packets[0].address == "/device-slot/devices"){
		console.log(oscBundle);
		var deviceSlotDevices = oscBundle.packets[1].packets;
		console.log(deviceSlotDevices);

		$.each( deviceSlotDevices, function( index, value ){
			$(".slotActive").after('<button class="deviceSlotDevice">'+ deviceSlotDevices[index].args[0] +'</button>');			
		});

	}


}

port.on("bundle", function (oscBundle) {

	bitwig.parseBundle(oscBundle);

	// $("#message").text(JSON.stringify(oscMessage, undefined, 2));
	// bitwig.parseMessage(oscMessage);
});

port.open();

var sendTest = function () {
	port.send({
		address: "/track",
		args: [1]
	});
};

</script>
</head>

<body>

<div id="bwSelector">
	<div id="currentTrack">
	</div>
	<div id="devices">
	</div>
</div>

<div id="messageArea">
	<pre id="message">Select a track</pre>
</div>

<button id="butSend" onclick="sendTest()">Send OSC message</button>

</body>
</html>
