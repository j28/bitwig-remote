<!DOCTYPE html>
<html>
<head>
<title>OSC Node.js Bitwig</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" sizes="180x180" href="assets/images/bitwig-192.png">

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" type="text/css" media="all" href="assets/css/bitwig.css"></link>
<script src="node_modules/jquery/dist/jquery.js"></script>
<script src="node_modules/osc/dist/osc-browser.min.js"></script>
<script src="../local-url.js"></script>
<!-- <script src="assets/js/live.js"></script> -->

<script type="text/javascript">

var bitwig = {};

bitwig.parseMessage = function (oscMessage) {

	var currentMessage = oscMessage;
	console.log(">> bitwig.parseMessage: " + currentMessage.address);
	console.log(currentMessage.args);

	if (currentMessage.address == "/track/name"){
		bitwig.currentTrackName(currentMessage);
	} else if (currentMessage.address == "/track/color"){
		bitwig.currentTrackColor(currentMessage);
	} else if (currentMessage.address == "/track/devices"){
		bitwig.currentTrackDevices(currentMessage);
	}

}

bitwig.currentTrackName = function (oscMessage) {

	console.log(">> bitwig.currentTrackName");
	console.log(oscMessage.args[0]);

	var currentTrack = oscMessage;
	var trackName = oscMessage.args[0];
	$("#currentTrack").text(trackName);

}

bitwig.currentTrackColor = function (oscMessage) {

	console.log(">> bitwig.currentTrackColor");
	console.log(oscMessage.args[0]);
	console.log(oscMessage.args[1]);
	console.log(oscMessage.args[2]);

	var currentTrack = oscMessage;
	var trackRed = oscMessage.args[0];
	var trackGreen = oscMessage.args[1];
	var trackBlue = oscMessage.args[2];

	var strBegin = "rgb(";
	var strComma = ", ";
	var strEnd = ")";
	var strFull = strBegin.concat(trackRed, strComma, trackGreen, strComma, trackBlue, strEnd);
	console.log(strFull);

	$("#currentTrack").css("background-color", strFull);

}

bitwig.currentTrackDevices = function (oscMessage) {

	console.log(">> bitwig.currentTrackDevices");
	console.log("incoming osc is" + oscMessage.args);

	var cursorDeviceIndex = oscMessage.args[0];

	oscMessage.args.splice(0,1);
	// console.log("after splie" + oscMessage.args);

	var currentTrack = oscMessage;
	// var trackDevice1 = oscMessage.args[0];
	// $("#currentTrack").text(trackName);

	$('#devices').html('')
	$.each( currentTrack.args, function( index, value ){
		if(index == cursorDeviceIndex ){
			$('#devices').append('<button data-index="' + index + '"' + ' class="deviceActive"'  + '>'+ value +'</button>');
		} else {
			$('#devices').append('<button data-index="' + index + '">'+ value +'</button>');
		}

	});

	$("#devices button").on( "click", function() {

		$("#devices button").removeClass( "deviceActive" );
		$( this ).addClass( "deviceActive" );
		var currentDeviceIndex = $( this ).data( "index" );
		// console.log("bananananannananan" + currentDeviceIndex );
		port.send({
			address: "/device",
			args: [currentDeviceIndex]
		});

	});

};

var port = new osc.WebSocketPort({
	url: localURL
});

// port.on("message", function (oscMessage) {
// 	$("#message").text(JSON.stringify(oscMessage, undefined, 2));
// 	bitwig.parseMessage(oscMessage);
// });


port.on("bundle", function (oscBundle) {

	// $("#message").text(JSON.stringify(oscBundle, null, 2));
// 	bitwig.parseMessage(oscMessage);

	console.log("bundle received..." + oscBundle.packets[0].address);

	if(oscBundle.packets[0].address == "/track/device/list"){
		// console.log("inside bundle");

		console.log(oscBundle);

		var trackName = oscBundle.packets[0].args[0];
		console.log("track name is: " + trackName);

		var devices = oscBundle.packets[1].packets;
		console.log("devices inside this track:");
		console.log(devices);

		var device1 = devices[0].packets[0].args[0];
		console.log("device1:");
		console.log(device1);

		var device2 = devices[1].packets[0].args[0];
		console.log("device2:");
		console.log(device2);


		// var device1Slot1 = oscBundle.packets[1].packets[0].packets[0].args[0];
		// console.log("device1Slot 1:");
		// console.log(device1Slot1);

		// var device1Slot2 = oscBundle.packets[1].packets[2].args[0];
		// console.log("device1Slot 2:");
		// console.log(device1Slot2);

		// var device2 = oscBundle.packets[2].packets[0].args[0];
		// console.log("device2:");
		// console.log(device2);


		// var device1Slots = oscBundle.packets[1].packets;
		// console.log(device1Slots);

		// var device2 = oscBundle.packets[2];
		// console.log(device2);
		// var device2Slots = oscBundle.packets[3].packets;
		// console.log(device2Slots);




		// console.log(oscBundle.packets[1].packets.length);

		// console.log("device 1 name is: "+ oscBundle.packets[0].args[0]);

		// console.log("device 2 name is: : "+ oscBundle.packets[2].args[0]);

		// console.log(oscBundle.packets[1].packets.length);
		// // oscBundle.packets.length;

		// // console.log("device 1 slot 1 is: " + oscBundle.packets[1].packets[0].args[0]);
		// // console.log("device 1 slot 1 is: " + oscBundle.packets[1].packets[1].args[0]);

		// console.log("device 2 slot 1 is: " + oscBundle.packets[3].packets[0].args[0]);
		// console.log("device 2 slot 1 is: " + oscBundle.packets[3].packets[1].args[0]);


	}



	// $("#message").text(JSON.stringify(oscMessage, undefined, 2));
	// bitwig.parseMessage(oscMessage);
});

port.open();

var sendTest = function () {
	port.send({
		address: "/track",
		args: [1]
	});
};

</script>
</head>

<body>

<div id="bwSelector">
	<div id="currentTrack">
	</div>
	<div id="devices">
	</div>
</div>

<div id="messageArea">
	<pre id="message">Select a track</pre>
</div>

<button id="butSend" onclick="sendTest()">Send OSC message</button>

</body>
</html>
