<!DOCTYPE html>
<html>
<head>
<title>OSC Node.js Bitwig</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" sizes="180x180" href="assets/images/bitwig-192.png">

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" type="text/css" media="all" href="assets/css/bitwig.css"></link>
<script src="node_modules/jquery/dist/jquery.js"></script>
<script src="node_modules/osc/dist/osc-browser.min.js"></script>
<script src="../local-url.js"></script>
<!-- <script src="assets/js/live.js"></script> -->

<script type="text/javascript">

// on ready
$(function() {
	if (window.navigator.standalone) {
		document.getElementById("messageArea").style.display = "none";
	}
});


var port = new osc.WebSocketPort({
	url: localURL
});

var bitwig = {};
bitwig.localState = [];

bitwig.parseMessage = function (oscMessage) {

	var currentMessage = oscMessage;
	console.log(">> bitwig.parseMessage: " + currentMessage.address);
	console.log(currentMessage.args);

	if (currentMessage.address == "/device-slot/devices"){
		// bitwig.cursorDeviceSet(currentMessage);
	// } else if (currentMessage.address == "/track/color"){
	// 	bitwig.currentTrackColor(currentMessage);
	// } else if (currentMessage.address == "/track/devices"){
	// 	// bitwig.currentTrackDevices(currentMessage);
	}

}

bitwig.currentTrackName = function (oscMessage) {

	console.log(">> bitwig.currentTrackName");
	console.log(oscMessage.args[0]);

	var currentTrack = oscMessage;
	var trackName = oscMessage.args[0];
	$("#currentTrack").text(trackName);

}

bitwig.currentTrackColor = function (oscMessage) {

	console.log(">> bitwig.currentTrackColor");
	console.log(oscMessage.args[0]);
	console.log(oscMessage.args[1]);
	console.log(oscMessage.args[2]);

	var currentTrack = oscMessage;
	var trackRed = oscMessage.args[0];
	var trackGreen = oscMessage.args[1];
	var trackBlue = oscMessage.args[2];

	var strBegin = "rgb(";
	var strComma = ", ";
	var strEnd = ")";
	var strFull = strBegin.concat(trackRed, strComma, trackGreen, strComma, trackBlue, strEnd);
	console.log(strFull);

	$("#currentTrack").css("background-color", strFull);

}

port.on("message", function (oscMessage) {
	// $("#message").text(JSON.stringify(oscMessage, undefined, 2));
	bitwig.parseMessage(oscMessage);
});

bitwig.parseBundle = function (oscBundle) {

	console.log("bundle received..." + oscBundle.packets[0].address);

	if(oscBundle.packets[0].address == "/track/position"){

		$("#message").text(JSON.stringify(oscBundle, null, 2));

		console.log(oscBundle);

		var trackPosition = oscBundle.packets[0].args[0];
		bitwig.localState[0] = trackPosition;

		var trackName = oscBundle.packets[1].args[0];
		console.log("track name is: " + trackName);
		$("#currentTrack").text(trackName);

		var trackColor = oscBundle.packets[2];
		console.log("track color is: " + trackColor);
		var trackRed = trackColor.args[0];
		var trackGreen = trackColor.args[1];
		var trackBlue = trackColor.args[2];
		var strBegin = "rgb(";
		var strComma = ", ";
		var strEnd = ")";
		var strFull = strBegin.concat(trackRed, strComma, trackGreen, strComma, trackBlue, strEnd);
		console.log(strFull);
		$("#currentTrack").css("background-color", strFull);

		var devices = oscBundle.packets[3].packets;
		console.log("devices inside this track:");
		console.log(devices);

		// var currentDeviceIndex = devices[0].args[0];
		// console.log("current device index is:");
		// console.log(currentDeviceIndex);

		// devices.splice(0,1);

		$('#devices').html('')
		$.each( devices, function( index, value ){

			var deviceName = value.packets[0].args[0];
			var isActive = value.packets[0].args[1];

			if(isActive == true ){
				$('#devices').append('<div><button class="device deviceActive" data-device-index="' + index + '"' + '>'+ deviceName +'</button><span></span></div>');
			} else {
				$('#devices').append('<div><button class="device" data-device-index="' + index + '">'+ deviceName +'</button><span></span></div>');
			}

			var deviceSlots = value.packets[1].packets;

			console.log("device slots:");
			console.log(deviceSlots);
			var deviceName = value.packets[0].args[0];
			console.log(deviceSlots);

			$.each( deviceSlots, function( slotIndex, slotValue ){
				var selectorString = "#devices div:eq(" +index +") span";

				console.log("selectorString:" + selectorString);

				console.log("slots array index is:" + slotIndex);
				// console.log("slots array value is:");
				var deviceSlot = slotValue.args[0];
				// console.log(deviceSlot);

				$(selectorString).append('<button class="deviceSlot" data-slot-name="'+deviceSlot+'" data-slot-index="' + slotIndex + '" data-parent-device-index="' + index + '">'+ deviceSlot +'</button>');
			});

		});

		$(".device").on( "click", function() {

			$(".device").removeClass( "deviceActive" );
			$(".deviceSlot").removeClass( "slotActive" );
			$( this ).addClass( "deviceActive" );
			bitwig.localState[1] = $( this ).data( "device-index" );

			bitwig.localState[2] = -1;
			bitwig.localState[3] = -1;


			console.log("bitwig.localState prior to osc send" );
			console.log(bitwig.localState[0]);
			console.log(bitwig.localState[1]);
			console.log(bitwig.localState[2]);
			console.log(bitwig.localState[3]);
			port.send({
				address: "/track",
				args: bitwig.localState
			});

		});

		$(".deviceSlot").on( "click", function() {

			$(".device").removeClass( "deviceActive" );
			$(".deviceSlot").removeClass( "slotActive" );
			$( this ).addClass( "slotActive" );
			var deviceSlotIndex = $( this ).data( "slot-index" );
			var parentDeviceIndex = $( this ).data( "parent-device-index" );

			bitwig.localState[1] = parentDeviceIndex;
			bitwig.localState[2] = deviceSlotIndex;
			bitwig.localState[3] = 0;

			console.log(bitwig.localState[0]);
			console.log(bitwig.localState[1]);
			console.log(bitwig.localState[2]);
			console.log(bitwig.localState[3]);

			// console.log("deviceSlotName is " + deviceSlotName );
			port.send({
				address: "/track",
				args: bitwig.localState
			});

		});

	} else if (oscBundle.packets[0].address == "/device-slot/devices"){

		// console.log(oscBundle);
		// var deviceSlotDevicesReversed = oscBundle.packets;
		var deviceSlotDevices = oscBundle.packets;
		console.log(deviceSlotDevices);

		$(".deviceSlotDevice").remove();
		$.each( deviceSlotDevices, function( index, value ){
			var isActive = deviceSlotDevices[index].args[1];

			if(isActive == true ){
				$(".slotActive").parent().append('<button class="deviceSlotDevice slotDeviceActive" data-slot-device="' + index +'">'+ deviceSlotDevices[index].args[0] +'</button>');			
			} else {
				$(".slotActive").parent().append('<button class="deviceSlotDevice" data-slot-device="' + index +'">'+ deviceSlotDevices[index].args[0] +'</button>');			
			}

		});

		$(".deviceSlotDevice").on( "click", function() {

			$(".deviceSlotDevice").removeClass( "deviceActive" );
			$(".deviceSlot").removeClass( "slotDeviceActive" );
			$( this ).addClass( "slotDeviceActive" );
			var slotDeviceIndex = $( this ).data( "slot-device" );
			bitwig.localState[3] = slotDeviceIndex;

			console.log("sending SLOT DEVICE");
			console.log(bitwig.localState[0]);
			console.log(bitwig.localState[1]);
			console.log(bitwig.localState[2]);
			console.log(bitwig.localState[3]);

			// console.log("deviceSlotName is " + deviceSlotName );
			port.send({
				address: "/track",
				args: bitwig.localState
			});

		});

	}

}

port.on("bundle", function (oscBundle) {

	bitwig.parseBundle(oscBundle);

	// $("#message").text(JSON.stringify(oscMessage, undefined, 2));
	// bitwig.parseMessage(oscMessage);
});

port.open();

var sendManual = function () {
	port.send({
		address: "/track",
		args: bitwig.localState
	});
};

</script>
</head>

<body>

<div id="bwSelector">
	<div id="currentTrack">
	</div>
	<div id="devices">
	</div>
</div>

<div id="messageArea">
	<pre id="message">Select a track</pre>
	<button id="butSend" onclick="sendManual()">Send OSC message</button>
</div>



</body>
</html>
